---
title: "General mixed linear models"
author: "Tracy Sánchez"
date: "Última actualización: `r format(Sys.Date(), format = '%d %B %Y')`" 
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    toc_depth: 6
    mathjax: null
    css: doc.css # To set style to maximum in a separate file
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA) # To delete all hashtags from output in HTML 
library(readr);library(dlookr);library(dplyr);
library(lme4);library(car);library(emmeans);library(MASS);library(jtools);
library(lmerTest);library(gmodels);library(nlme); library(multcompView);
library(ggplot2)
#emm_options(lmerTest.limit = 10000)
#emm_options(pbkrtest.limit = 10000)
```

# Loading Data 

```{r echo = FALSE,warning = FALSE }

HumanA <- read.csv("/Users/tracysanchezpacheco/Documents/Resources/humanA_Behavioural.csv", sep =",")
head(HumanA)
```

```{r echo = FALSE,warning = FALSE }
unique(HumanA$ID)
```


```{r echo = FALSE,warning = FALSE }
HumanA <- HumanA %>% dplyr::filter(!ID %in% c(0479, 2361, 3246, 3572, 3976, 5238, 5531, 5895, 7264))
```



# Recoding for effects and formating factors 
```{r }

HumanA$ContextEffectf <-dplyr::recode(HumanA$Context, 
                                      False = -0.5, True= 0.5,
                                      .default = NaN)
HumanA$AgentPresence <-dplyr::recode(HumanA$AvatarPresenceCategory,
                                             Omitted = -0.5, Present= 0.5,
                                             .default = NaN)
HumanA$ContextEffectf <-factor(HumanA$ContextEffectf,levels= c(-0.5, 0.5), 
                               labels=c('Residential', 'Public')) 
HumanA$AgentPresencef <-factor(HumanA$AgentPresence,
                                levels= c(-0.5, 0.5), 
                                labels=c('Omitted', 'Displayed')) 
```
# Data descriptives
```{r}
MainVariables <- subset(HumanA, select = c(AbsolutError, RT))
summary(MainVariables)
```

```{r}
summary(HumanA$AgentPresence)

```


```{r}
df = HumanA[complete.cases(HumanA),]
ggplot(df, aes(x=ContextEffectf,  y=AbsolutError, fill=AgentPresencef)) + 
  geom_boxplot(notch=TRUE,
        notchwidth = 0.8,
        outlier.colour="red",
        outlier.fill="red",
        outlier.size=0.5)
ggplot(df, aes(x=ContextEffectf,  y=RT, fill=AgentPresencef)) + 
  geom_boxplot(notch=TRUE,
        notchwidth = 0.8,
        outlier.colour="red",
        outlier.fill="red",
        outlier.size=0.5)
```

```{r }
library(dplyr)
TwoFactorTable <- HumanA %>% 
  group_by(ContextEffectf, AgentPresencef)%>%
  summarise(AccuracyMean = mean(AbsolutError, na.rm = TRUE),
            n=n(),
            AccuracyStandardDev = sd(AbsolutError, na.rm = TRUE),
            RTMean = mean(RT, na.rm = TRUE),
            RTStandardDev = sd(RT, na.rm = TRUE))
library(tidyr)
TwoFactorTableUnite <- TwoFactorTable %>%
  unite("TwoFactor", ContextEffectf:AgentPresencef, sep= " ", remove = F)
  
TwoFactorTableUnite <-  TwoFactorTableUnite %>%
  mutate( AccuracyStandardError=AccuracyStandardDev/sqrt(n)) %>%  
  mutate( AccuracyStandardIC=AccuracyStandardDev * qt((1-0.05)/2 + .5, n-1)) %>%
  mutate( RTStandardError=RTStandardDev/sqrt(n)) 

```

 

```{r echo=FALSE}
ggplot(data=subset(TwoFactorTableUnite, !is.na(AgentPresencef)),
       aes(x     = ContextEffectf,
           y     = AccuracyMean,
           group = AgentPresencef)) +

    geom_point(aes(shape=AgentPresencef, linetype =AgentPresencef), position=position_dodge(0.3)) +

    geom_errorbar(aes(linetype=AgentPresencef,
                      ymin= AccuracyMean-AccuracyStandardError, 
                      ymax=AccuracyMean+AccuracyStandardError),
                      position=position_dodge(0.3),
                      width =  0.2,
                      size  =  0.7) +

    theme_bw() +
    theme(axis.title   = element_text(face = "bold"),
          axis.text    = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +

    ylab("Absolute angular error in degrees") +
    xlab("Location") +
    ylim(44,54) + 
    ggtitle ("Accuracy performance",

             subtitle = "The effect of location  and presence") +

                 labs(caption  = paste0( 
                                   "Error bars indicate one Standard Error \n"),
                            hjust=0.5) 
# Response Time 

ggplot(data=subset(TwoFactorTableUnite, !is.na(AgentPresencef)),
       aes(x     = ContextEffectf,
           y     = RTMean,
           group = AgentPresencef)) +

    geom_point(aes(shape=AgentPresencef, linetype =AgentPresencef), position=position_dodge(0.3)) +

    geom_errorbar(aes(linetype=AgentPresencef,
                      ymin= RTMean-RTStandardError, 
                      ymax=RTMean+RTStandardError),
                      position=position_dodge(0.3),
                      width =  0.2,
                      size  =  0.7) +

    theme_bw() +
    theme(axis.title   = element_text(face = "bold"),
          axis.text    = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +

    ylab("Response Time in Seconds") +
    xlab("Location") +
    ggtitle ("Response Time",

             subtitle = "The effect of location  and presence") +

                 labs(caption  = paste0( 
                                   "Error bars indicate one Standard Error \n"),
                            hjust=0.5) 
```





## Checking for the distribution of Absolut error
```{r warning = FALSE }
df = HumanA[complete.cases(HumanA),]
df$AbsolutErrorR <- round(df$AbsolutError, digits = 3)
qqp(df$AbsolutErrorR, "norm")
qqp(df$AbsolutErrorR, "lnorm")
```


# Linear mixed models

## Assessing the need for a multilevel model

```{r}
interceptOnly <-gls(AbsolutError ~ 1, data = df, 
                    method = "ML")
IDrandomInterceptOnly <-lme(AbsolutError ~ 1, data = df,  
                            random =~1|ID,
                            method = "ML")
StartlocationsrandomIntercept <-update(IDrandomInterceptOnly, .~.,   
                              random=~1|ID/PointingTaskStartingLocations,
                              method= "ML")
```
Including Id and starting position as random effects significantly improves the fit of the model 

## Absolut Error Models

I am adding one main factor at a time 
```{r}
MeaningfulContext <-update(StartlocationsrandomIntercept, .~. + ContextEffectf)
summary(MeaningfulContext)
Anova(MeaningfulContext, test.statistic="F", type=3)
```
```{r}
Presence <-update(MeaningfulContext, .~. + AgentPresencef)
summary(Presence)
Anova(Presence, test.statistic="F", type=3)
```

```{r}
TwofactorInteraction <-update(Presence, .~. + ContextEffectf*AgentPresencef)
summary(TwofactorInteraction)
Anova(TwofactorInteraction)
Pairwise<- emmeans(TwofactorInteraction, pairwise ~ ContextEffectf*AgentPresencef)
Pairwise
plot(Pairwise[[2]], CIs = TRUE)
```
```{r}
library(multcomp);library(multcompView)
CLD <- cld(Pairwise,
          alpha=0.05,
          Letters=letters,
          adjust="sidak")
ggplot(CLD,
       aes(x     = ContextEffectf,
           y     = emmean,
           group = AgentPresencef,
           colours = .group)) +

    geom_point(aes(shape=AgentPresencef, linetype =AgentPresencef), position=position_dodge(0.3)) +

    geom_errorbar(aes(linetype=AgentPresencef,
                      ymin  =  lower.CL,
                      ymax  =  upper.CL),
                      position=position_dodge(0.3),
                      width =  0.2,
                      size  =  0.7) +

    theme_bw() +
    theme(axis.title   = element_text(face = "bold"),
          axis.text    = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +

    ylab("Estimated marginal mean\ Absolute angular error") +
    xlab("Location location") +
    ggtitle ("Marginal Means",

             subtitle = "location * Presence") +

                 labs(caption  = paste0( 
                                   "Boxes indicate the EM mean. \n",
                                   "Error bars indicate the 95% ",
                                   "confidence interval of the EM mean. \n"),
                            hjust=0.5) 
```

```{r}
anova(interceptOnly, IDrandomInterceptOnly, StartlocationsrandomIntercept, 
      MeaningfulContext, Presence, TwofactorInteraction )
```

```{r}
plot(TwofactorInteraction, which = 1)
plot(MeaningfulContext, which = 1)
```
```{r}
GHQ <- glmer(AbsolutError ~  ContextEffectf*AgentPresencef + (1|ID), data = HumanAf,family=gaussian(link = "log"), nAGQ = 25)  
summary(GHQ)
Anova(GHQ)
anova(GHQ)
emmeans(GHQ, pairwise ~ ContextEffectf:AgentPresencef, type = "response")
```
```{r}
plot(fitted(GHQ), residuals(GHQ), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(GHQ), residuals(GHQ)))
```
```{r}
interceptOnly <-gls(log(AbsolutError) ~ 1, data = df, 
                    method = "ML")
IDrandomInterceptOnly <-lme(log(AbsolutError) ~ 1, data = df,  
                            random =~1|ID,
                            method = "ML")
StartlocationsrandomIntercept <-update(IDrandomInterceptOnly, .~.,   
                              random=~1|ID/PointingTaskStartingLocations,
                              method= "ML")
MeaningfulContext <-update(StartlocationsrandomIntercept, .~. + ContextEffectf)
Presence <-update(MeaningfulContext, .~. + AgentPresencef)
TwofactorInteraction <-update(Presence, .~. + ContextEffectf*AgentPresencef)
summary(TwofactorInteraction)
Anova(TwofactorInteraction)
Pairwise<- emmeans(TwofactorInteraction, pairwise ~ ContextEffectf*AgentPresencef, type='response')
Pairwise 
plot(Pairwise[[2]])
anova(interceptOnly, IDrandomInterceptOnly, StartlocationsrandomIntercept, 
      MeaningfulContext, Presence, TwofactorInteraction )
plot(TwofactorInteraction, which = 1)
```
```{r}
model <- glmmPQL(RT_Building ~  ContextEffectf*AgentPresencef, ~1|ID/PointingTaskStartingLocations,  family = gaussian(link = "log"), data = HumanAf, verbose = FALSE)
summary(model)
```




## Response Time models 
## Checking for the distribution of RT

```{r warning = FALSE }
df = HumanAf[complete.cases(HumanAf),]
df$RTr <- round(df$RT_Building, digits = 3)
qqp(df$RT_Building, "norm")
qqp(df$RT_Building, "lnorm")
```

```{r}
interceptOnlyt <-gls(log(RT_Buildingr) ~ 1, data = df, 
                    method = "ML")
IDrandomInterceptOnlyt <-lme(log(RTr) ~ 1, data = df,  
                            random =~1|ID,
                            method = "ML")
StartlocationsrandomInterceptt <-lme(log(RTr) ~ 1, data = df,   
                              random=~1|ID|PointingTaskStartingLocations,
                              method= "ML")
MeaningfulContext <-update(StartlocationsrandomInterceptt, .~. + ContextEffectf)
Presence <-update(MeaningfulContext, .~. + AgentPresencef)
TwofactorInteraction <-update(Presence, .~. + ContextEffectf*AgentPresencef)
summary(TwofactorInteraction)
Anova(TwofactorInteraction)
Pairwiset<- emmeans(TwofactorInteraction, pairwise ~ ContextEffectf*AgentPresencef, type='response')
Pairwiset 
ref_grid(TwofactorInteraction)
plot(Pairwiset[[2]])
anova(interceptOnlyt, IDrandomInterceptOnlyt, StartlocationsrandomInterceptt, 
      MeaningfulContext, Presence, TwofactorInteraction )
plot(TwofactorInteraction, which = 1)
```
```{r}

CLD <- cld(Pairwiset,
          alpha=0.05,
          Letters=letters,
          adjust="sidak")
ggplot(CLD,
       aes(x     = ContextEffectf,
           y     = response,
           group = AgentPresencef,
           colours = .group)) +

    geom_point(aes(shape=AgentPresencef, color=AgentPresencef), position=position_dodge(0.3)) +

    geom_errorbar(aes(color=AgentPresencef,
                      ymin  =  lower.CL,
                      ymax  =  upper.CL),
                      position=position_dodge(0.3),
                      width =  0.2,
                      size  =  0.7) +

    theme_bw() +
    theme(axis.title   = element_text(face = "bold"),
          axis.text    = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +

    ylab("Estimated marginal mean\ Response Time in Seconds") +
    xlab("Location location") +
    ggtitle ("Marginal Means",

             subtitle = "location * Presence") +

                 labs(caption  = paste0( 
                                   "Boxes indicate the EM mean. \n",
                                   "Error bars indicate the 95% ",
                                   "confidence interval of the EM mean. \n"),
                            hjust=0.5) 
```


```{r}
HumanAf$Agent_Category <- with(HumanAf, ave(seq_along(ID), ID, FUN = function(x) sample(c(rep('Action', ceiling(length(x)*0.6)), rep('Standing', length(x) - ceiling(length(x)*0.6))))))
```

```{r }
library(dplyr)
TwoFactorTable <- HumanAf %>% 
  group_by(ContextEffectf, AgentPresencef, Agent_Category)%>%
  summarise(AccuracyMean = mean(AbsolutError, na.rm = TRUE),
            n=n(),
            AccuracyStandardDev = sd(AbsolutError, na.rm = TRUE),
            RTMean = mean(RT, na.rm = TRUE),
            RTStandardDev = sd(RT, na.rm = TRUE))
library(tidyr)
TwoFactorTableUnite <- TwoFactorTable %>%
  unite("TwoFactor", ContextEffectf:Agent_Category, sep= " ", remove = F)
  
TwoFactorTableUnite <-  TwoFactorTableUnite %>%
  mutate( AccuracyStandardError=AccuracyStandardDev/sqrt(n)) %>%  
  mutate( AccuracyStandardIC=AccuracyStandardDev * qt((1-0.05)/2 + .5, n-1)) %>%
  mutate( RTStandardError=RTStandardDev/sqrt(n)) 

```



```{r}
ggplot(data=subset(TwoFactorTableUnite, !is.na(AgentPresencef)),
       aes(x     = ContextEffectf,
           y     = AccuracyMean,
           group = Agent_Category)) +

    geom_point(aes(shape=Agent_Category, linetype =Agent_Category), position=position_dodge(0.3)) +

    geom_errorbar(aes(linetype=Agent_Category,
                      ymin= AccuracyMean-AccuracyStandardError, 
                      ymax=AccuracyMean+AccuracyStandardError),
                      position=position_dodge(0.3),
                      width =  0.2,
                      size  =  0.7) +
  facet_wrap(~ AgentPresencef) +

    theme_bw() +
    theme(axis.title   = element_text(face = "bold"),
          axis.text    = element_text(face = "bold"),
          plot.caption = element_text(hjust = 0)) +

    ylab("Absolute angular error in degrees") +
    xlab("Location location") +
    ggtitle ("Accuracy performance",

             subtitle = "The effect of location  and presence") +

                 labs(caption  = paste0( 
                                   "Error bars indicate one Standard Error \n"),
                            hjust=0.5) 
```




